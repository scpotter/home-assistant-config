# Important: Host needs SNMP installed first for HAOS from terminal run:
# apk add net-snmp-tools

template:
  - sensor:
      - name: "Rack PDU Battery Level"
        unique_id: rack_pdu_battery
        state: "{{ states('sensor.rackups_battery_charge') }}"
        unit_of_measurement: "%"
        device_class: battery
        availability: "{{ states('sensor.rackups_battery_charge') not in ['unknown','unavailable'] }}"

      - name: "Rack PDU Status"
        unique_id: rack_pdu_status
        state: "{{ states('sensor.rackups_status') }}"
        availability: "{{ states('sensor.rackups_status') not in ['unknown','unavailable'] }}"

  - binary_sensor:
      - name: "Rack PDU On Battery"
        unique_id: rack_pdu_on_battery
        state: "{{ is_state('binary_sensor.rackups_status', 'on_battery') }}"
        device_class: power

command_line:
  - switch:
      name: "Rack PDU Outlet 1"
      unique_id: rack_pdu_outlet_1
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.1 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.1 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.1"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 2"
      unique_id: rack_pdu_outlet_2
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.2 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.2 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.2"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 3"
      unique_id: rack_pdu_outlet_3
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.3 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.3 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.3"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 4"
      unique_id: rack_pdu_outlet_4
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.4 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.4 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.4"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 5"
      unique_id: rack_pdu_outlet_5
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.5 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.5 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.5"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 6"
      unique_id: rack_pdu_outlet_6
      command_on: !secret PDU_outlet6_on
      command_off: !secret PDU_outlet6_off
      command_state: !secret PDU_outlet6_state
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 7"
      unique_id: rack_pdu_outlet_7
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.7 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.7 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.7"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

  - switch:
      name: "Rack PDU Outlet 8"
      unique_id: rack_pdu_outlet_8
      command_on:  "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.8 i 1"
      command_off: "snmpset -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.3.8 i 2"
      command_state: "snmpget -v1 -c !secret PDU_community !secret PDU_IPv4 .1.3.6.1.4.1.318.1.1.4.4.2.1.4.8"
      value_template: "{{ 'on' if value == '1' else 'off' }}"

group:
  rack_pdu:
    name: "Rack PDU"
    entities:
      - sensor.rack_pdu_battery_level
      - sensor.rack_pdu_status
      - binary_sensor.rack_pdu_on_battery
      - switch.rack_pdu_outlet_1
      - switch.rack_pdu_outlet_2
      - switch.rack_pdu_outlet_3
      - switch.rack_pdu_outlet_4
      - switch.rack_pdu_outlet_5
      - switch.rack_pdu_outlet_6
      - switch.rack_pdu_outlet_7
      - switch.rack_pdu_outlet_8
